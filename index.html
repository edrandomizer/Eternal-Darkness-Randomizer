<!DOCTYPE html>
<html>

<head>
    <title>Eternal Darkness Random</title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">

	<style type="text/css">

	    input {
	        margin-top: 10px;
	    }
	</style>
</head>

<body>
    <div>
		<input type="file">
    </div>
    <div id="message"></div>
    <div id="options">
		<input type="checkbox" id="text_control"  checked="checked" />Randomize text<br />
		<input type="checkbox" id="enemy_control" checked="checked" />Randomize enemies<br />
		<input type="checkbox" id="rune_control" checked="checked" />Randomize rune locations<br />
		<input type="checkbox" id="gate_control" checked="checked" />Remove spell gates<br />
		<input type="input" id="seed" placeholder="Seed (leave blank for random)"></br>
    </div>

    <script type="text/javascript">
		let input = document.querySelector('input');

		function download(iso, filename="download.file"){
			iso=asBuf(iso);
			const blob=new Blob([iso]);
			const ele=document.createElement('a');
			const url = URL.createObjectURL(blob);
			ele.setAttribute('href', url);
			ele.setAttribute('download', filename);
			ele.style.visibility = 'hidden';
			document.body.appendChild(ele);
			ele.click();
			document.body.removeChild(ele);
		}

		var iso=null;
		var manualMode=false;
		var compressionBypassNeeded=false;

		input.addEventListener('change', () => {
			let files = input.files;

			if (files.length == 0) return;

			const file = files[0];

			if(document.getElementById("seed").value===""){
				let u = new Uint32Array(1);
				window.crypto.getRandomValues(u);
				seed=u[0];
			}else{
				seed=parseInt(document.getElementById("seed").value, 16);
			}

			Math.random=mulberry32(seed);

			let reader = new FileReader();
			displayMessage("Loading");
			reader.onload = (e) => {
				const file = e.target.result;

				displayMessage("Analyzing");
				window.setTimeout(function(){
					var niso=new GCISO(file);

					if(manualMode){
						iso=niso;
						displayMessage("Ready");
					}else{
						displayMessage("Patching");
						window.setTimeout(function(){
							if(document.getElementById("text_control").checked){
								compressionBypassNeeded=true;
								roomTextShuffle(niso);
							}
							if(document.getElementById("enemy_control").checked){
								randomizeEnemies(niso, [
								null, //alex
								null, //pious
								[null, null, null, [0, 1]], //Two locked room zombies in ellia
								null, //anthony
								null, //karim
								null, //max
								null, //lindsey
								null, //paul
								],
								[
								null, null, null, null, null, null, null, null, null, [null, null, null, [8,9,10]],//edward's caged enemies
								]);
							}
							if(document.getElementById("rune_control").checked){
								randomizeRunes(niso);
							}
							if(document.getElementById("gate_control").checked){
								removeSpellGates(niso);
							}

							const completeDownload=()=>{
								displayMessage("Rebuilding");
								window.setTimeout(function(){
									var buf=niso.toBuffer();
									displayMessage("Preparing download");
									download(buf,  "ED.random."+(seed.toString(16))+".iso");
								}, 1);
							};

							if(compressionBypassNeeded){
								prepare(niso);
								bypassCompression(niso, function(){
									completeDownload();
								});
							}else{
								completeDownload();
							}
						}, 1);
					}
				}, 1);
			};

			reader.onerror = (e) => alert(e.target.error.name);

			reader.readAsArrayBuffer(file);
		});

		function mulberry32(a) {
		    return function() {
		      var t = a += 0x6D2B79F5;
		      t = Math.imul(t ^ t >>> 15, t | 1);
		      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
		      return ((t ^ t >>> 14) >>> 0) / 4294967296;
		    }
		}

		function displayMessage(message){
			document.getElementById("message").innerHTML=message;
		}

    </script>
    <script src="./edrandom.js"></script>
    <script src="./eternaldarkness.js"></script>
    <script src="./gciso.js"></script>
    <script src="./skasc.js"></script>
</body>

</html>
